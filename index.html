<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lecteur IPTV ‚Äî ‚Äú2 pages‚Äù dans une seule (scroll-snap, 100vw)</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script defer src="https://cdn.jsdelivr.net/npm/hls.js@1.5.13/dist/hls.min.js"></script>
  <style>
    :root{
      --bg:#0b0d12; --card:#10131a; --muted:#9fb3c8; --ac:#00d2ff; --ac2:#2ef2aa; --red:#ff5d6c;
      --line:#171b24; --line2:#222838; --chip:#0f1724;
    }
    *{box-sizing:border-box}
    html,body{ margin:0;background:var(--bg);color:#e7f8ff;font-family:system-ui,Segoe UI,Roboto,Inter,Arial; width:100%; overflow-x:hidden; }
    a{color:var(--ac)}
    .wrap{max-width:1400px; width:100%; margin:16px auto; padding:0 12px}
    .row{display:grid;gap:12px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      box-shadow:0 6px 24px rgba(0,0,0,.35);
      max-width:100%;
    }

    /* ===== Lecteur ===== */
    #playerWrap{padding:10px; position:relative;}
    #video{ width:100%; aspect-ratio:16/9; max-height:75vh; background:#000; border-radius:10px; object-fit:contain; }
    .toolbar{display:flex;justify-content:space-between;align-items:center;margin-top:6px;font-size:12px;color:#9fb3c8}
    .badge{padding:3px 8px;border-radius:20px;background:var(--chip);border:1px solid var(--line2)}
    #nowPlaying{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:75%}
    #loading,#err,#unmute{display:none}
    #err{margin-top:8px;padding:10px;border-radius:10px;background:#1a1013;color:#ffd9e0;border:1px solid #4a1d27}
    #loading{position:absolute;inset:auto 12px 12px auto;background:#0c1320aa;color:#cfe8ff;padding:8px 10px;border-radius:10px}
    #unmute{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:#08121fda;color:#e7f8ff;border:1px solid var(--line2);padding:10px 14px;border-radius:999px}

    /* ===== Dock d'entr√©e ===== */
    #inputDock{padding:12px;display:grid;gap:10px}
    .dock-row{ display:grid; gap:10px; grid-template-columns: 1fr; }
    #src{ width:100%; font-size:16px; padding:14px 16px; height:56px; border-radius:10px; border:1px solid var(--line2); background:#0c111b; color:#dfefff; }
    #btnLoad{ width:100%; background:linear-gradient(90deg,var(--ac),var(--ac2)); color:#002433;border:0;padding:12px 16px;border-radius:10px;font-weight:700;cursor:pointer }
    #btnLoad:disabled{opacity:.5;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    input[type="file"]{color:var(--muted)}

    /* ===== Desktop : deux colonnes c√¥te √† c√¥te ===== */
    #listsWrap{ padding:0; }
    .split{
      display:grid;
      grid-template-columns: 280px 1fr;   /* gauche Cat√©gories | droite Cha√Ænes */
      gap:0; border-radius:14px; overflow:hidden;
    }
    .pane{ min-height:420px; }
    .pane + .pane{ border-left:1px solid var(--line); }

    /* ===== Mobile : slider horizontal (sans d√©bordement) ===== */
    @media (max-width: 880px){
      .split{ display:block; }

      #slider{
        display:flex; width:100%; max-width:100%;
        overflow-x:auto; overflow-y:hidden;
        scroll-snap-type:x mandatory;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
      }
      #slider::-webkit-scrollbar{ display:none }

      .pane{
        flex:0 0 100%; max-width:100%; max-height:70vh;
        overflow:auto; scroll-snap-align:start; border-left:none;
      }

      #backRow{
        display:flex; align-items:center; gap:8px;
        position:sticky; top:0; z-index:3; background:var(--card); padding:6px 0 4px;
      }
      #btnBackCats{
        background:#0f1420; border:1px solid var(--line2); color:#cfe8ff;
        padding:8px 12px; border-radius:10px; font-weight:600;
      }
      #pagerDots{ display:flex; }
    }

    /* S√©curit√© anti-d√©bordement global */
    html, body, .wrap, #listsWrap, .card { max-width:100%; overflow-x:hidden; }

    /* ===== Panneau Cat√©gories ===== */
    #catsPane{ padding:12px; overflow:auto; max-height:62vh; }
    #catsTitle{ font-size:12px; color:var(--muted); margin:2px 2px 8px; }
    #cats{ display:flex; flex-direction:column; gap:6px; }
    .cat{
      background:#0f1420;border:1px solid var(--line2);color:#cfe8ff;
      padding:10px 12px;border-radius:10px;font-size:14px;cursor:pointer; text-align:left;
    }
    .cat:hover{ border-color:#2a3246 }
    .cat.active{ outline:2px solid var(--ac); background:#0d1a24 }

    /* ===== Panneau Cha√Ænes ===== */
    #channelsPane{ padding:12px; display:flex; flex-direction:column; gap:10px; }
    #searchRow{ display:flex; gap:8px; align-items:center; }
    #search{ flex:1; padding:10px 12px; border-radius:10px; border:1px solid var(--line2); background:#0c111b; color:#dfefff }
    .count{ font-size:12px; color:#9fb3c8 }
    #channels{ display:grid; gap:8px; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); padding-bottom:8px }
    .chan{ display:flex; gap:10px; align-items:center; padding:8px; border:1px solid var(--line2); border-radius:12px; background:#0e1220; cursor:pointer }
    .chan:hover{ border-color:#2a3246 }
    .logo{ width:42px;height:42px;border-radius:8px;background:#0a0f18;border:1px solid #0c1320;object-fit:contain }
    .meta{ min-width:0 }
    .nm{ font-size:14px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .gp{ font-size:12px; color:#9fb3c8 }

    /* ===== Puces slider ===== */
    #pagerDots{
      display:none; gap:8px; justify-content:center; align-items:center;
      margin:10px 0 0; padding:8px 0;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background:#2a3246; border:1px solid #38425a; opacity:.8;
      transition:transform .2s ease, background .2s ease, opacity .2s ease;
    }
    .dot.active{ background:var(--ac); border-color:#004f6b; opacity:1; transform:scale(1.15); }
    @media (min-width: 881px){ #backRow{ display:none; } }

    /* ===== ‚ú® AJOUT : Barre de progression + avis reconnexion ===== */
    #playerWrap { position: relative; }
    #liveBar{
      position:absolute; left:10px; right:10px; bottom:-8px; height:6px;
      background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; z-index:5;
    }
    #liveBuf{ position:absolute; top:0; left:0; height:100%; width:0%;
      background:#1f2b44; transition:width .25s ease; }
    #livePos{ position:absolute; top:0; left:0; height:100%; width:0%;
      background:linear-gradient(90deg,#00e6ff,#00c2ff); transition:width .25s ease; }
    .reconnect-notice{
      position:absolute; left:50%; bottom:26px; transform:translateX(-50%);
      background:rgba(0,100,200,.85); color:#fff; padding:10px 14px; border-radius:12px;
      font-size:13px; z-index:6; display:none;
    }

    /* ===== ‚ú® AJOUT : Styles M3U sauvegard√©s ===== */
    .saved-block{ 
      border:1px solid var(--line); background:rgba(16,19,26,.6); 
      border-radius:12px; padding:10px; margin-bottom:10px;
    }
    .saved-head{ font-weight:700; color:#dfefff; margin:2px 4px 8px; font-size:14px; display:flex; align-items:center; gap:8px }
    .saved-list{ display:flex; flex-direction:column; gap:8px; }

    .saved-item{
      display:flex; align-items:flex-start; gap:10px;
      padding:10px; border:1px solid var(--line2); background:#0e1220; border-radius:12px;
    }
    .saved-url{
      flex:1; min-width:0; 
      font-size:13px; line-height:1.25; color:#cfe8ff; 
      word-break:break-all; white-space:pre-wrap;
    }
    .saved-actions{ display:flex; gap:8px; flex-shrink:0; }
    .btn-icon{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius:999px; border:1px solid #2a3246;
      background:#0f1420; color:#dfefff; cursor:pointer; font-size:16px;
    }
    .btn-icon:hover{ border-color:#3a4663 }
    .btn-play{ background:linear-gradient(90deg,var(--ac),var(--ac2)); color:#002433; border:0; }
    .btn-del { background:#101826; color:#b9c7dc; }
    .btn-icon:active{ transform:translateY(1px); }

/* ===== Tiroir SOURCES ===== */
#inputDock{
  position: relative;
  padding-top: 22px;      /* espace constant sous le bouton */
  overflow: visible;      /* le bouton reste dehors */
}

.drawer-toggle{
  position: absolute;
  left: 0;
  right: 0;
  margin: 0 auto;          /* centrage horizontal fixe */
  top: -20px;              /* bouton ancr√© √† l'ext√©rieur */
  width: 38px; height: 38px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
  border: 0;
  background: linear-gradient(90deg,var(--ac),var(--ac2));
  color: #002433; font-size: 16px; font-weight: 700; cursor: pointer;
  box-shadow: 0 2px 10px rgba(0,0,0,.25);
  z-index: 20;
}

/* optionnel: petit effet d'appui sans d√©centrer */
.drawer-toggle:active{ transform: translateY(1px); }

.drawer-content{
  overflow: hidden;
  max-height: 1000px;
  transition: max-height .35s ease;
  will-change: max-height;
  border-radius: 12px;
}
.drawer-collapsed .drawer-content{ max-height: 0 !important; }
  </style>
</head>
<body>
  <div class="wrap row">
    <!-- 1) LECTEUR -->
    <section id="playerWrap" class="card">
      <video id="video" controls playsinline preload="auto"></video>

      <!-- ‚ú® AJOUT: barre de progression + avis reconnexion -->
      <div id="liveBar">
        <div id="liveBuf"></div>
        <div id="livePos"></div>
      </div>
      <div id="reco" class="reconnect-notice">Reconnexion‚Ä¶</div>

      <div class="toolbar">
        <div id="nowPlaying" class="badge">Aucun flux en lecture</div>
        <div id="engineBadge" class="badge" title="Moteur vid√©o">init</div>
      </div>
      <div id="loading">Chargement‚Ä¶</div>
      <div id="err" role="alert"></div>
      <button id="unmute" type="button">üîä Activer le son</button>
    </section>

    <!-- 2) SOURCES (tiroir) -->
    <section id="inputDock" class="card">
      <!-- Bouton tiroir -->
      <button id="drawerToggle" class="drawer-toggle" aria-expanded="true" aria-controls="drawerContent" title="Fermer / Ouvrir">
        ‚ñ≤
      </button>

      <!-- Contenu repliable -->
      <div id="drawerContent" class="drawer-content">
        <!-- ‚ñº‚ñº M3U sauvegard√©s (local) ‚ñº‚ñº -->
        <div id="savedWrap" class="saved-block">
          <div class="saved-head">üíæ M3U guardados (local)</div>
          <div id="savedList" class="saved-list"></div>
        </div>
        <!-- ‚ñ≤‚ñ≤ M3U sauvegard√©s (local) ‚ñ≤‚ñ≤ -->

        <!-- ‚ñº‚ñº Serveurs int√©gr√©s (texte externe) ‚ñº‚ñº -->
        <div id="serversWrap" class="saved-block">
          <div class="saved-head">üåê Serveurs int√©gr√©s</div>
          <div id="serverList" class="saved-list"></div>
        </div>
        <!-- ‚ñ≤‚ñ≤ Serveurs int√©gr√©s ‚ñ≤‚ñ≤ -->

        <div class="dock-row">
          <input id="src" type="url" placeholder="Collez un lien M3U OU Xtream (get.php / player_api.php)" />
          <button id="btnLoad">Charger</button>
          <label class="hint">
            <input id="file" type="file" accept=".m3u,.m3u8,application/x-mpegURL,text/plain" />
          </label>
        </div>
      </div>
    </section>

    <!-- 3) ‚ÄúDeux pages‚Äù dans un seul slider -->
    <section id="listsWrap" class="card">
      <div class="split">
        <div id="slider">
          <!-- Vue 1 : Cat√©gories -->
          <aside id="catsPane" class="pane" tabindex="0" aria-label="Cat√©gories">
            <div id="catsTitle">Cat√©gories</div>
            <div id="cats"></div>
          </aside>

          <!-- Vue 2 : Cha√Ænes -->
          <main id="channelsPane" class="pane" tabindex="0" aria-label="Cha√Ænes">
            <div id="searchRow">
              <input id="search" type="text" placeholder="Rechercher une cha√Æne‚Ä¶" />
              <div class="count" id="count"></div>
            </div>
            <div id="channels"></div>
          </main>
        </div>
      </div>

      <!-- Puces -->
      <div id="pagerDots" aria-hidden="true">
        <span class="dot" data-index="0" title="Cat√©gories"></span>
        <span class="dot" data-index="1" title="Cha√Ænes"></span>
      </div>
    </section>
  </div>
  <!-- Scripts -->
  <script>
/************ PROXY Xtream (JSON seulement) ************/
const PROXY = 'https://vegetatv1.vegetatvoficial.workers.dev/?url=';
const through = u => PROXY + encodeURIComponent(u);

/************ Refs ************/
const video = document.getElementById('video');
const nowPlaying = document.getElementById('nowPlaying');
const engineBadge = document.getElementById('engineBadge');
const errBox = document.getElementById('err');
const loading = document.getElementById('loading');
const unmuteBtn = document.getElementById('unmute');

const srcInput = document.getElementById('src');
const fileInput = document.getElementById('file');
const btnLoad = document.getElementById('btnLoad');

/************ Drawer (tiroir SOURCES) ************/
const drawer = document.getElementById('inputDock');
const drawerContent = document.getElementById('drawerContent');
const drawerToggle = document.getElementById('drawerToggle');

function setDrawer(open){
  drawer.classList.toggle('drawer-collapsed', !open);
  drawerToggle.setAttribute('aria-expanded', String(open));
  drawerToggle.textContent = open ? '‚ñ≤' : '‚ñº';   // fl√®che
  if(open){
    drawerContent.style.maxHeight = drawerContent.scrollHeight + 'px';
  }else{
    drawerContent.style.maxHeight = '0px';
  }
}

function toggleDrawer(){ 
  setDrawer(drawerToggle.getAttribute('aria-expanded') !== 'true'); 
}

drawerToggle.addEventListener('click', toggleDrawer);
window.addEventListener('resize', ()=>{
  // si ouvert, recalcule la hauteur √† la vol√©e
  if(drawerToggle.getAttribute('aria-expanded') === 'true'){
    drawerContent.style.maxHeight = drawerContent.scrollHeight + 'px';
  }
});
const slider = document.getElementById('slider');   // conteneur scrollable horizontal (mobile)
const catsDiv = document.getElementById('cats');
const channelsDiv = document.getElementById('channels');
const searchInput = document.getElementById('search');
const count = document.getElementById('count');
const btnBackCats = document.getElementById('btnBackCats');
const pagerDots = document.getElementById('pagerDots');

/* ‚ú® AJOUT: refs barre de progression + reco */
const liveBuf = document.getElementById('liveBuf');
const livePos = document.getElementById('livePos');
const reco = document.getElementById('reco');

let hls=null, triedTsFallback=false;
let currentList=[], currentByGroup={}, visibleItems=[];
let xtream=null, groupOrder=[], activeGroupIndex=-1;

/************ Utils ************/
const isHls = (u)=>/\.m3u8(\?|$)/i.test(u);
const isMp4 = (u)=>/\.(mp4|mov|m4v)(\?|$)/i.test(u);
const clean = s => (s||'').replace(/\s+/g,' ').trim();
const groupKey = s => (s||'Autres').trim()||'Autres';
function uniqBy(arr, key) { 
  const seen=new Set(); 
  return arr.filter(x=>{ 
    const k=key(x); 
    if(seen.has(k)) return false; 
    seen.add(k); 
    return true; 
  }); 
}
function showErr(msg){ 
  if(!msg){errBox.style.display='none';errBox.textContent='';return;} 
  errBox.textContent=msg; 
  errBox.style.display='block'; 
}
function showLoading(s){ loading.style.display = s? 'block':'none'; }
function setNow(t){ nowPlaying.textContent = t||'Aucun flux en lecture'; }
function setEngine(t){ engineBadge.textContent = t; }
const isMobile = ()=> window.matchMedia('(max-width: 880px)').matches;

/************ M3U r√©cents (localStorage) ************/
const LS_KEY = 'm3u_saved_v1';

function _loadSaved(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]') || []; }
  catch(_){ return []; }
}
function _saveSaved(arr){
  try{ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
  catch(_){}
}
function _normalizeUrl(u){ return (u||'').trim(); }

function renderSaved(){
  const box = document.getElementById('savedList');
  if(!box) return;
  const arr = _loadSaved();
  box.innerHTML = '';
  if(!arr.length){ 
    box.innerHTML = '<div class="hint" style="padding:6px 8px">Aucun lien enregistr√©.</div>'; 
    return; 
  }
  const frag = document.createDocumentFragment();
  arr.forEach((url, idx)=>{
    const row = document.createElement('div'); row.className='saved-item';
    const urlDiv = document.createElement('div'); urlDiv.className='saved-url'; urlDiv.textContent = url;
    const act = document.createElement('div'); act.className='saved-actions';
    const bPlay = document.createElement('button'); 
    bPlay.className='btn-icon btn-play'; 
    bPlay.title='Reproduire'; 
    bPlay.textContent='‚ñ∂';
    const bDel  = document.createElement('button'); 
    bDel.className='btn-icon btn-del';  
    bDel.title='Supprimer';    
    bDel.textContent='‚úñ';
    bPlay.addEventListener('click', ()=>{ loadSource(url, {save:true}); });
    bDel .addEventListener('click', ()=>{ removeSaved(idx); });
    act.append(bPlay,bDel);
    row.append(urlDiv, act);
    frag.appendChild(row);
  });
  box.appendChild(frag);
}

// === Fonction principale pour charger une source ===
async function loadSource(src, {save=true, label=null} = {}){
  const source = (src||'').trim();
  if(!source) return;

  setDrawer(false);

  if(save) addSaved(source);

  showErr('');
  triedTsFallback = false; 
  setNow(label || '');  
  xtream = getXtream(source);

  if(xtream) {
    await loadFromXtream(xtream);
  } else {
    try {
      showLoading(true);
      const r = await fetch(source, {mode:'cors'}); 
      if(!r.ok) throw new Error('HTTP '+r.status);
      const text = await r.text();
      await loadFromM3UText(text);
    } catch(e) { 
      showErr('Impossible de charger la liste M3U. Essayez le fichier local.'); 
      console.error(e);
    } finally { 
      showLoading(false); 
    }
  }
}

// === Bouton "Charger" (M3U de l'utilisateur) ===
btnLoad.addEventListener('click', ()=>{
  const v = (srcInput.value || '').trim();
  if(!v) return;
  loadSource(v, {save:true});   // enregistre et charge le M3U saisi
});

async function renderServersTxt(){
  try {
    const res = await fetch('serveurs.txt');
    if(!res.ok) return;

    // Enl√®ve un √©ventuel BOM et d√©coupe sur tous les types de retours √† la ligne
    const text = (await res.text()).replace(/^\uFEFF/, '');
    const urls = text
      .split(/\r\n|\n|\r/)             // <-- plus robuste que /\r?\n/
      .map(u => u.trim())
      .filter(u => u && !u.startsWith('#'));  // ignore vides et commentaires

    const box = document.getElementById('serverList');
    if(!box) return;
    box.innerHTML = '';

    urls.forEach((url, i) => {
      const row = document.createElement('div'); row.className = 'saved-item';
      const name = 'Serveur ' + (i + 1);

      const urlDiv = document.createElement('div');
      urlDiv.className = 'saved-url';
      urlDiv.textContent = name; // on n'affiche jamais l'URL

      const act = document.createElement('div'); act.className = 'saved-actions';
      const bPlay = document.createElement('button');
      bPlay.className = 'btn-icon btn-play';
      bPlay.title = 'Reproduire';
      bPlay.textContent = '‚ñ∂';
      bPlay.addEventListener('click', () => {
        loadSource(url, { save:false, label:name });
      });

      act.append(bPlay);
      row.append(urlDiv, act);
      box.appendChild(row);
    });

    // Optionnel: affiche un message s'il n'y a rien √† lister
    if (urls.length === 0) {
      box.innerHTML = '<div class="hint" style="padding:6px 8px">Aucun serveur int√©gr√©.</div>';
    }
  } catch (e) {
    console.error('Impossible de charger serveurs.txt', e);
  }
}

// üëâ Appelle apr√®s avoir affich√© les M3U sauvegard√©s
renderSaved();
renderServersTxt();

function addSaved(url){
  url = _normalizeUrl(url); if(!url) return;
  let arr = _loadSaved();
  // √©viter doublons ‚Üí remonter en t√™te
  arr = arr.filter(x=>x !== url);
  arr.unshift(url);
  // limiter √† 10
  if(arr.length > 10) arr = arr.slice(0,10);
  _saveSaved(arr);
  renderSaved();
}

function removeSaved(index){
  const arr = _loadSaved();
  arr.splice(index,1);
  _saveSaved(arr);
  renderSaved();
}
/************ Slider (mobile) ************/
function goSlide(i){
  if(!isMobile()) return;
  slider.scrollTo({left: i*slider.clientWidth, behavior:'smooth'});
  setActiveDot(i);
}
function setActiveDot(i){
  pagerDots.querySelectorAll('.dot').forEach(d=>d.classList.remove('active'));
  const d = pagerDots.querySelector(`.dot[data-index="${i}"]`);
  if(d) d.classList.add('active');
}
setActiveDot(0);

pagerDots.addEventListener('click', e=>{
  const dot = e.target.closest('.dot'); if(!dot) return;
  goSlide(parseInt(dot.dataset.index,10)||0);
});
slider.addEventListener('scroll', ()=>{
  if(!isMobile()) return;
  const idx = Math.round(slider.scrollLeft / slider.clientWidth);
  setActiveDot(idx);
});
window.addEventListener('resize', ()=>{
  if(!isMobile()) { setActiveDot(0); return; }
  const idx = parseInt(pagerDots.querySelector('.dot.active')?.dataset.index||'0',10);
  slider.scrollLeft = idx*slider.clientWidth; // garde l'alignement
});

/************ D√©tection Xtream ************/
function getXtream(src){
  try{
    const u=new URL(src), sp=u.searchParams, base=u.origin;
    if (u.pathname.includes('get.php') || u.pathname.includes('player_api.php')){
      const username=sp.get('username')||sp.get('user')||'';
      const password=sp.get('password')||sp.get('pass')||'';
      if(username && password) return {base,username,password};
    }
  }catch(_){}
  return null;
}
async function fetchJson(url){
  const r=await fetch(through(url));
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}

/************ Charger source ************/
fileInput.addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0]; if(!f) return;
  const txt = await f.text(); await loadFromM3UText(txt);
});

async function loadSource(src, {save=true, label=null} = {}){
  const source = (src||'').trim();
  if(!source) return;

  // Ferme le tiroir
  setDrawer(false);

  // Sauvegarde uniquement si demand√© (pas pour les serveurs cach√©s)
  if(save) addSaved(source);

  showErr('');
  triedTsFallback = false;
  setNow(label || '');
  xtream = getXtream(source);

  if(xtream) {
    await loadFromXtream(xtream);
  } else {
    try{
      showLoading(true);
      const r = await fetch(source, {mode:'cors'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      const text = await r.text();
      await loadFromM3UText(text);
    } catch(e){
      showErr('Impossible de charger la liste M3U. Essayez le fichier local.');
      console.error(e);
    } finally {
      showLoading(false);
    }
  }
}

/************ M3U ************/
async function loadFromM3UText(text){
  const items=[], lines=text.split(/\r?\n/);
  for(let i=0;i<lines.length;i++){
    const L=lines[i].trim();
    if(L.startsWith('#EXTINF')){
      const info=L; let j=i+1, url='';
      while(j<lines.length){ const t=lines[j].trim(); if(t && !t.startsWith('#')){ url=t; break;} j++; }
      i=j; if(!url) continue;
      const name = info.includes(',') ? info.split(',').slice(1).join(',').trim() : 'Cha√Æne';
      const g1 = info.match(/group-title="([^"]*)"/i);
      const group = groupKey(g1?g1[1]:'Autres');
      const lg = info.match(/tvg-logo="([^"]*)"/i);
      const logo = lg?lg[1]:'';
      items.push({name:clean(name), group, url:url.trim(), logo});
    }
  }
  if(!items.length){ showErr('Aucune entr√©e #EXTINF trouv√©e.'); return; }
  currentList = uniqBy(items, x=>x.name+'|'+x.url);
  buildGroups();
  if(isMobile()) goSlide(0); // on reste sur Cat√©gories
}

function buildGroups(){
  const map={};
  currentList.forEach(it=>{ const g=groupKey(it.group); (map[g]??=[]).push(it); map[g]=map[g]; });
  currentByGroup = map;
  renderCategories(Object.keys(map).sort((a,b)=>a.localeCompare(b)));
}

/************ Xtream ************/
async function loadFromXtream({base,username,password}){
  try{
    showLoading(true); showErr('');
    const cats = await fetchJson(`${base}/player_api.php?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&action=get_live_categories`);
    currentList = []; currentByGroup = {}; renderXtreamCats(cats,{base,username,password});
    channelsDiv.innerHTML = '<div class="hint">Choisissez une cat√©gorie pour lister ses cha√Ænes.</div>';
    if(isMobile()) goSlide(0);
  }catch(e){ console.error(e); showErr('√âchec du chargement Xtream.'); }
  finally{ showLoading(false); }
}
function renderXtreamCats(cats, creds){
  catsDiv.innerHTML=''; const frag=document.createDocumentFragment(); const order=[];
  cats.forEach(c=>{
    const id=c.category_id||''; const title=c.category_name||c.category_title||('Cat '+id);
    const btn=document.createElement('button'); btn.className='cat'; btn.textContent=title;
    btn.addEventListener('click', ()=> selectXtreamCategory(id,title,creds,btn));
    frag.appendChild(btn); order.push(title);
  });
  catsDiv.appendChild(frag); groupOrder=order; activeGroupIndex=-1; count.textContent=''; searchInput.value='';
}

async function selectXtreamCategory(catId,title,{base,username,password},btn){
  activateCat(btn,title);
  channelsDiv.innerHTML='<div class="hint">Chargement des cha√Ænes‚Ä¶</div>';
  try{
    const arr = await fetchJson(`${base}/player_api.php?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&action=get_live_streams&category_id=${encodeURIComponent(catId)}`);
    const items = arr.map(s=>({
      name: clean(s.name||s.stream_display_name||('Stream '+s.stream_id)),
      group: title,
      url: `${base}/live/${encodeURIComponent(username)}/${encodeURIComponent(password)}/${s.stream_id}.m3u8`,
      logo: s.stream_icon||''
    }));
    currentByGroup[title]=items; visibleItems=items.slice();
    renderChannels(visibleItems); count.textContent=`${items.length} cha√Ænes`; wireSearch(items);
    if(isMobile()) goSlide(1);
  }catch(e){ console.error(e); showErr('Impossible de charger cette cat√©gorie.'); }
}

/************ Rendu cat√©gories (M3U) ************/
function renderCategories(groups){
  catsDiv.innerHTML=''; const frag=document.createDocumentFragment(); const order=[];
  groups.forEach(g=>{
    const btn=document.createElement('button'); btn.className='cat'; btn.textContent=g;
    btn.addEventListener('click', ()=> selectGroup(g,btn));
    frag.appendChild(btn); order.push(g);
  });
  catsDiv.appendChild(frag); groupOrder=order;
  if(order.length && !isMobile()) selectGroup(order[0], catsDiv.querySelector('.cat'));
}

function selectGroup(g, btn){
  activateCat(btn,g);
  const items=(currentByGroup[g]||[]).slice(); visibleItems=items;
  renderChannels(items); count.textContent=`${items.length} cha√Ænes`; wireSearch(items);
  if(isMobile()) goSlide(1);
}

function activateCat(btn,name){
  catsDiv.querySelectorAll('.cat').forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  activeGroupIndex = Math.max(0, groupOrder.indexOf(name));
  searchInput.value='';
}

/************ Recherche + Rendu cha√Ænes ************/
function wireSearch(items){
  searchInput.oninput = ()=>{
    const q = searchInput.value.toLowerCase();
    const filtered = items.filter(x=> x.name.toLowerCase().includes(q));
    visibleItems = filtered; renderChannels(filtered);
    count.textContent = `${filtered.length}/${items.length}`;
  };
}
function renderChannels(items){
  channelsDiv.innerHTML='';
  if(!items || !items.length){ channelsDiv.innerHTML='<div class="hint">Aucune cha√Æne</div>'; return; }
  const frag=document.createDocumentFragment();
  items.forEach(ch=>{
    const li=document.createElement('div'); li.className='chan';
    li.innerHTML=`
      <img class="logo" src="${ch.logo||''}" alt="" onerror="this.style.visibility='hidden'"/>
      <div class="meta"><div class="nm" title="${ch.name}">${ch.name}</div><div class="gp">${ch.group||''}</div></div>`;
    li.addEventListener('click', ()=> playUrl(ch.url, ch.name));
    frag.appendChild(li);
  });
  channelsDiv.appendChild(frag);
}

/************ ‚ú® AJOUT: helper barre de progression ************/
function _updateProgressBar(v, bufEl, posEl){
  if(!v || v.readyState < 1) return;
  try{
    if (v.duration && v.duration !== Infinity) {
      const pct = (v.currentTime / v.duration) * 100;
      posEl.style.width = pct + '%';
      if (v.buffered.length) {
        const end = v.buffered.end(v.buffered.length - 1);
        const bp = Math.min(100, (end / v.duration) * 100);
        bufEl.style.width = bp + '%';
      }
    } else if (v.seekable && v.seekable.length) {
      const start = v.seekable.start(0), end = v.seekable.end(0);
      const pct = ((v.currentTime - start) / (end - start)) * 100;
      posEl.style.width = Math.max(0, Math.min(100, pct)) + '%';
      if (v.buffered.length) {
        const bend = v.buffered.end(v.buffered.length - 1);
        const bp = ((bend - start) / (end - start)) * 100;
        bufEl.style.width = Math.max(0, Math.min(100, bp)) + '%';
      }
    }
  }catch(_){}
}

/************ Lecture (REMPLAC√âE uniquement) ************/
let _reconnectAttempts = 0, _maxReconnect = 10, _reconnectDelay = 700;
let _frozenTimer = null, _loadTimer = null, _lastPos = 0, _ended = false;

function _showReco(s){ if(reco) reco.style.display = s ? 'block' : 'none'; }
function destroyHls(){ if(hls){ try{ hls.destroy(); }catch(_){ } hls=null; } }

async function playUrl(url,label){
  showErr(''); setNow(label||''); triedTsFallback=false; _ended=false; _lastPos=0;
  if(_frozenTimer) clearTimeout(_frozenTimer);
  if(_loadTimer) clearTimeout(_loadTimer);

  const canHlsJs = window.Hls && Hls.isSupported() && isHls(url);
  function scheduleFrozenCheck(){
    if(_frozenTimer) clearTimeout(_frozenTimer);
    _frozenTimer = setTimeout(()=>{
      if(!video.paused && video.currentTime === _lastPos && video.currentTime > 0){
        _reconnect();
      }
    }, 1200);
  }
  function _reconnect(){
    if(_reconnectAttempts >= _maxReconnect){
      showErr('Reiniciando‚Ä¶ '+_maxReconnect+' intentos');
      return;
    }
    _reconnectAttempts++;
    _showReco(true);
    destroyHls();
    video.removeAttribute('src'); video.load?.();
    setTimeout(()=>{ _init(); _showReco(false); }, _reconnectDelay);
  }
  async function _tryPlay(){
    try{
      await video.play();
      showLoading(false);
      unmuteBtn.style.display = (video.muted || video.volume===0) ? 'inline-flex' : 'none';
    }catch(_){}
  }
  function _fallbackDirect(){
    destroyHls();
    video.src = url;
    setEngine(isHls(url) ? 'HLS natif' : (isMp4(url)?'MP4':'HTML5'));
    _reconnectAttempts=0; _ended=false;
    setTimeout(_tryPlay, 200);
  }
  function _wireOnce(){
    if(video._wiredEnhanced) return;
    video.addEventListener('timeupdate', ()=>{
      _updateProgressBar(video, liveBuf, livePos);
      _lastPos = video.currentTime;
      scheduleFrozenCheck();
    }, {passive:true});
    video.addEventListener('waiting', ()=> showLoading(true), {passive:true});
    video.addEventListener('playing', ()=>{
      showLoading(false); _ended=false; _reconnectAttempts=0;
      if(_frozenTimer) clearTimeout(_frozenTimer);
    }, {passive:true});
    video.addEventListener('ended', ()=>{ _ended=true; _reconnect(); }, {passive:true});
    video.addEventListener('volumechange', ()=>{
      unmuteBtn.style.display = (video.muted || video.volume===0) ? 'inline-flex' : 'none';
    }, {passive:true});
    unmuteBtn.addEventListener('click', ()=>{
      try{ video.muted=false; video.volume=Math.max(video.volume||0,0.8); video.play().catch(()=>{});}catch(_){}
    });
    video._wiredEnhanced = true;
  }
  function _init(){
    showLoading(true);
    if(_loadTimer) clearTimeout(_loadTimer);
    _loadTimer = setTimeout(()=>{
      if(video.readyState < 2){ showErr('Le flux met trop de temps √† charger'); showLoading(false); _reconnect(); }
    }, 20000);

    if(canHlsJs){
      try{
        destroyHls();
        hls = new Hls({
          lowLatencyMode:true,
          liveSyncDurationCount:3,
          liveMaxLatencyDurationCount:10,
          maxBufferLength:20,
          maxMaxBufferLength:60,
          backBufferLength:90,
          enableWorker:true,
          fragLoadingTimeOut:10000,
          manifestLoadingTimeOut:10000,
          debug:false
        });
        hls.attachMedia(video);
        hls.loadSource(url);

        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{
          clearTimeout(_loadTimer);
          setEngine('hls.js');
          _reconnectAttempts=0; _ended=false;
          setTimeout(_tryPlay, 200);
        });

        hls.on(Hls.Events.ERROR, (_e, d)=>{
          if(d?.fatal){
            if(d.type === Hls.ErrorTypes.NETWORK_ERROR){
              try{ hls.startLoad(); }catch(_){}
            }else if(d.type === Hls.ErrorTypes.MEDIA_ERROR){
              try{ hls.recoverMediaError(); }catch(_){}
            }else{
              destroyHls();
              if(!triedTsFallback && isHls(url)){
                triedTsFallback = true;
                playUrl(url.replace(/\.m3u8(\?|$)/i, '.ts$1'), label);
              }else{
                _fallbackDirect();
              }
            }
          }
        });
      }catch(_){ _fallbackDirect(); }
    }else{
      _fallbackDirect();
    }
  }

  _wireOnce();
  _init();

  video.onerror = ()=>{
    const code = (video.error && video.error.code) || 0;
    const map = {1:"abandon",2:"erreur r√©seau",3:"erreur d√©codage",4:"source non support√©e"};
    showErr("Erreur : " + (map[code] || "inconnue"));
    showLoading(false);
    _reconnect();
  };
}

/************ Unmute (inchang√©) ************/
unmuteBtn.addEventListener('click', ()=>{ try{ video.muted=false; video.volume=Math.max(video.volume||0,0.7); video.play().catch(()=>{});}catch(_){} });
video.addEventListener('volumechange', ()=>{ unmuteBtn.style.display = (video.muted || video.volume===0) ? 'inline-flex' : 'none'; }, {passive:true});

/************ Clavier ************/
function goCategory(delta){
  if(!groupOrder.length) return;
  let idx = activeGroupIndex<0?0:activeGroupIndex;
  idx = (idx + delta + groupOrder.length) % groupOrder.length;
  const name = groupOrder[idx];
  const btn = catsDiv.querySelectorAll('.cat')[idx];
  if(xtream && currentByGroup[name]===undefined){ btn?.click(); } else { selectGroup(name, btn); }
  if(isMobile()) goSlide(1);
}
document.getElementById('catsPane').addEventListener('keydown', (e)=>{ if(e.key==='ArrowRight'){ e.preventDefault(); goSlide(1);} });
document.getElementById('channelsPane').addEventListener('keydown', (e)=>{
  if(e.key==='ArrowLeft'){ e.preventDefault(); goSlide(0); }
  if(e.key==='ArrowRight'){ e.preventDefault(); goCategory(+1); }
  if(e.key==='ArrowLeft' && e.shiftKey){ e.preventDefault(); goCategory(-1); }
});

/************ Auto-init ************/
(function init(){
  setActiveDot(0);

  // üëâ affiche les M3U sauvegard√©s d√®s le chargement
  renderSaved();

  const h = decodeURIComponent(location.hash.slice(1));
  if(h){ 
    srcInput.value = h; 
    btnLoad.click(); 
  }
})();
</script>
</body>
</html>