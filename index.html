<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VEGETA TV — Player M3U</title>
<meta name="theme-color" content="#0b0b0f">
<style>
  :root{ --bg:#0b0b0f; --card:#11131a; --ink:#e7f8ff; --muted:#a7b3c2; --accent:#00e6ff; --accent-2:#00c2ff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent)}
  /* Splash */
  #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .6s ease;opacity:1}
  #splash img{width:min(60vw,360px);filter:drop-shadow(0 0 22px rgba(0,230,255,.35))}
  #splash.hide{opacity:0;pointer-events:none}
  /* Header */
  header{padding:18px 16px;border-bottom:1px solid #1a1d25;background:linear-gradient(180deg,#0e1118,transparent);position:sticky;top:0;z-index:10}
  .brand{display:flex;gap:12px;align-items:center}
  .brand img{width:40px;height:40px;object-fit:contain}
  .brand h1{font-size:20px;margin:0;letter-spacing:.5px}
  /* Layout */
  .container{max-width:1100px;margin:18px auto;padding:0 14px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:900px){.row{grid-template-columns:360px 1fr}}
  .card{background:var(--card);border:1px solid #1a1d25;border-radius:16px;padding:14px}
  .input,.btn{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1c2130;background:#0f1220;color:var(--ink)}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#001016;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:#0f1220;border:1px dashed #2a3144;color:#a7b3c2}
  .pill{font-size:12px;border:1px solid #244054;background:#0e1b2a;border-radius:999px;padding:4px 8px;color:#9ad7ff}
  .hint{color:#a7b3c2;font-size:13px}
  .tabs{display:flex;gap:8px;margin-top:10px}
  .tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:#0f1220;border:1px solid #1a1d25;cursor:pointer}
  .tab.active{background:#132033;border-color:#1e3753;box-shadow:0 0 0 1px #1e3753 inset}
  .panel{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;max-height:60vh;overflow:auto;padding-right:2px}
  .item{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid #1a1d25;border-radius:12px;background:#0f1220;cursor:pointer;transition:transform .05s ease}
  .item:hover{transform:scale(1.01)}
  .logo{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#0b0b0f;border:1px solid #1a1d25}
  #playerWrap{position:sticky;top:80px;border-radius:16px;overflow:hidden}
  video{width:100%;background:#000;min-height:220px;border-radius:12px}
  .search{display:flex;gap:8px}
  .search input{flex:1}
  footer{color:#8090a0;font-size:12px;text-align:center;padding:30px 10px}
</style>
</head>
<body>

<!-- Splash -->
<div id="splash" role="img" aria-label="VEGETA TV — cargando">
  <img id="splashLogo" alt="VEGETA TV Logo">
</div>

<header>
  <div class="brand">
    <img id="brandLogo" alt="Logo">
    <h1>VEGETA TV — Reproductor M3U</h1>
  </div>
</header>

<div class="container row">
  <!-- Player & entradas -->
  <section class="card" id="playerWrap">
    <video id="video" controls playsinline></video>
    <div style="margin-top:12px" class="search">
      <input id="m3uUrl" class="input" placeholder="Pega tu enlace M3U (https://...get.php?username=...)" />
      <button id="btnLoad" class="btn">Cargar</button>
    </div>
    <div style="margin-top:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label class="ghost btn" style="display:inline-block;position:relative;overflow:hidden;width:auto">
        <input id="file" type="file" accept=".m3u,.m3u8,.txt" style="position:absolute;inset:0;opacity:0;cursor:pointer">
        Abrir archivo .m3u
      </label>
      <span class="hint">Si el servidor bloquea CORS, descarga el .m3u y ábrelo aquí.</span>
    </div>
    <div id="status" class="hint" style="margin-top:8px"></div>
  </section>

  <!-- Listas -->
  <section class="card">
    <div class="search">
      <input id="q" class="input" placeholder="Buscar canal / película / grupo…" />
      <span id="count" class="pill">0 ítems</span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="live">TV en vivo</button>
      <button class="tab" data-tab="vod">VOD / Películas & Series</button>
    </div>

    <div id="list-live" class="panel"></div>
    <div id="list-vod" class="panel" style="display:none"></div>
  </section>
</div>

<footer>
  Usa solo fuentes <b>autorizadas</b>. Este reproductor no evita protecciones; solo reproduce flujos compatibles con navegador.
</footer>

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
<script>
/* ======== CONFIGURA AQUÍ LA RUTA DEL LOGO ======== */
const LOGO_URL = "logo.png"; // si alojas el logo en CDN, pon la URL absoluta

function applyLogo(){
  const splash = document.getElementById("splashLogo");
  const brand  = document.getElementById("brandLogo");
  splash.src = LOGO_URL; brand.src = LOGO_URL;
  // Fallback a SVG de texto si falla
  const fallback = () => {
    const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="black"/><text x="50%" y="50%" fill="#00e6ff" font-size="48" font-family="Arial" text-anchor="middle" dominant-baseline="middle">VEGETA TV</text></svg>');
    const data = "data:image/svg+xml;charset=utf-8,"+svg;
    splash.src = data; brand.src = data;
  };
  splash.onerror = fallback; brand.onerror = fallback;
}

/* ========== Splash ========== */
(function(){
  applyLogo();
  const splash = document.getElementById('splash');
  setTimeout(()=> splash.classList.add('hide'), 1500);
  setTimeout(()=> splash.remove(), 2100);
})();

/* ========== Estado ========== */
let ALL_ITEMS = []; // {name,url,group,logo,isVod}
let FILTER_TAB = 'live';
const el = (id)=>document.getElementById(id);
const status = el('status'), video = el('video');

/* ========== Player ========== */
let hls;
function playUrl(url){
  if (hls){ hls.destroy(); hls = null; }
  video.src = '';
  if (/\.m3u8(\?|$)/i.test(url)){
    if (Hls.isSupported()){
      hls = new Hls({lowLatencyMode:true});
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
    } else if (video.canPlayType('application/vnd.apple.mpegurl')){
      video.src = url; video.play().catch(()=>{});
    } else {
      msg("Tu navegador no soporta HLS.", "warn");
    }
  } else {
    video.src = url;
    video.play().catch(()=>{});
  }
}

/* ========== Tabs & búsqueda ========== */
for (const t of document.querySelectorAll('.tab')){
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    FILTER_TAB = t.dataset.tab;
    document.getElementById('list-live').style.display = FILTER_TAB==='live'?'grid':'none';
    document.getElementById('list-vod').style.display  = FILTER_TAB==='vod' ?'grid':'none';
    render();
  });
}
el('q').addEventListener('input', render);

/* ========== Cargar M3U desde URL ========== */
el('btnLoad').addEventListener('click', async ()=>{
  const url = el('m3uUrl').value.trim();
  if (!url){ msg("Pega un enlace M3U válido."); return; }
  msg("Cargando M3U…");
  try{
    const res = await fetch(url, {mode:'cors'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    parseAndStore(text);
    msg("Playlist cargada ✔️");
  }catch(e){
    msg("No se pudo cargar directo (CORS o acceso). Descarga el archivo y ábrelo con el botón.", "warn");
    console.error(e);
  }
});

/* ========== Cargar M3U desde archivo ========== */
el('file').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0];
  if (!f) return;
  msg("Leyendo archivo M3U…");
  const text = await f.text();
  parseAndStore(text);
  msg("Playlist cargada ✔️");
});

/* ========== Parseo de M3U ========== */
function parseAndStore(text){
  ALL_ITEMS = [];
  if (!text.startsWith('#EXTM3U')) msg("Este archivo no parece M3U (#EXTM3U faltante).", "warn");
  const lines = text.split(/\r?\n/);
  for (let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if (line.startsWith('#EXTINF')){
      const meta = line;
      let url = ''; let j = i+1; while (j<lines.length && !lines[j].trim()) j++;
      url = (lines[j]||'').trim();
      const getAttr = (key)=>{ const m=meta.match(new RegExp(key+'="([^"]*)"','i')); return m?m[1]:''; };
      const tvgName = getAttr('tvg-name');
      const nameMatch = meta.match(/,(.*)$/);
      const name = (tvgName || (nameMatch?nameMatch[1].trim():'')) || 'Sin nombre';
      const group = getAttr('group-title') || 'Varios';
      const logo  = getAttr('tvg-logo') || LOGO_URL;
      const isVod = /\.(mp4|mkv|avi|mov)(\?|$)/i.test(url) || /vod|movie|series|film|pelicul|serie|cinema/.test(group.toLowerCase());
      if (url && /^https?:\/\//i.test(url)) ALL_ITEMS.push({name,url,group,logo,isVod});
      i = j;
    }
  }
  render(true);
}

/* ========== Render ========== */
function msg(text, level="info"){ const pfx={info:'',warn:'⚠️ ',err:'⛔ '}; el('status').textContent=(pfx[level]||'')+text; }
function render(resetScroll=false){
  const q = el('q').value.trim().toLowerCase();
  const live = ALL_ITEMS.filter(x=>!x.isVod), vod = ALL_ITEMS.filter(x=>x.isVod);
  const filt = (arr)=> arr.filter(x=> !q || [x.name,x.group].join(' ').toLowerCase().includes(q));
  const liveF = filt(live), vodF = filt(vod);
  el('count').textContent = `${(FILTER_TAB==='live'?liveF.length:vodF.length)} ítems`;
  paint('list-live', liveF); paint('list-vod', vodF);
  if (resetScroll){ document.getElementById('list-live').scrollTop=0; document.getElementById('list-vod').scrollTop=0; }
}
function paint(id, items){
  const root=document.getElementById(id); root.innerHTML='';
  if(!items.length){ root.innerHTML = `<div class="hint">Sin resultados.</div>`; return; }
  for(const it of items.slice(0,5000)){
    const div=document.createElement('div'); div.className='item';
    const img=document.createElement('img'); img.className='logo'; img.src=it.logo||LOGO_URL; img.onerror=()=>{img.src=LOGO_URL;};
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div style="font-weight:600">${escapeHtml(it.name)}</div><div class="hint">${escapeHtml(it.group)}</div>`;
    const badge=document.createElement('div'); badge.className='pill'; badge.textContent=it.isVod?'VOD':'LIVE';
    div.appendChild(img); div.appendChild(meta); div.appendChild(badge);
    div.addEventListener('click', ()=> playUrl(it.url));
    root.appendChild(div);
  }
}
function escapeHtml(s){return s.replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]))}
</script>
</body>
</html>
